{% extends 'base.html' %}

{% block title %}–°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i>–í—Å–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
        </h5>
        <div class="d-flex gap-2">
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#filterModal">
                <i class="bi bi-funnel"></i> –§–ò–õ–¨–¢–†–´
                {% if active_filters_count > 0 %}
                <span class="badge bg-danger">{{ active_filters_count }}</span>
                {% endif %}
            </button>
            <a href="/admin/equipments/equipment/add/" class="btn btn-sm btn-primary" target="_blank">
                <i class="bi bi-plus-circle me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
            </a>
        </div>
    </div>

    <div class="card-body">
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (—á–∏–ø—ã) -->
        {% if active_filters_count > 0 %}
        <div class="mb-3">
            <small class="text-muted">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</small>
            <div class="d-flex flex-wrap gap-2 mt-1">
                {% if status_filter %}
                <span class="badge bg-primary">
                    –°—Ç–∞—Ç—É—Å: {{ status_filter_display }}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'status' %}{{ key }}={{ value }}&{% endif %}{% endfor %}"
                        class="text-white text-decoration-none">
                        <i class="bi bi-x ms-1"></i>
                    </a>
                </span>
                {% endif %}

                {% if type_filter %}
                <span class="badge bg-primary">
                    –¢–∏–ø: {{ type_filter_display }}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'type' %}{{ key }}={{ value }}&{% endif %}{% endfor %}"
                        class="text-white text-decoration-none">
                        <i class="bi bi-x ms-1"></i>
                    </a>
                </span>
                {% endif %}

                {% if missing_filter %}
                <span class="badge bg-warning text-dark">
                    –ë–µ–∑: {{ missing_filter_display }}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'missing' %}{{ key }}={{ value }}&{% endif %}{% endfor %}"
                        class="text-dark text-decoration-none">
                        <i class="bi bi-x ms-1"></i>
                    </a>
                </span>
                {% endif %}

                {% if active_filters_count > 0 %}
                <a href="{% url 'equipments:equipment_list' %}" class="text-decoration-none">
                    <small><i class="bi bi-x-circle"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</small>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="row mb-4">
            <div class="col-md-6">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="available" {% if status_filter == 'available' %}selected{% endif %}>–ù–∞ —Å–∫–ª–∞–¥–µ
                            </option>
                            <option value="issued" {% if status_filter == 'issued' %}selected{% endif %}>–í—ã–¥–∞–Ω–æ</option>
                            <option value="broken" {% if status_filter == 'broken' %}selected{% endif %}>–°–ª–æ–º–∞–Ω</option>
                            <option value="repair" {% if status_filter == 'repair' %}selected{% endif %}>–í —Ä–µ–º–æ–Ω—Ç–µ
                            </option>
                            <option value="written_off" {% if status_filter == 'written_off' %}selected{% endif %}>–°–ø–∏—Å–∞–Ω
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">–¢–∏–ø</label>
                        <select name="type" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="laptop" {% if type_filter == 'laptop' %}selected{% endif %}>–ù–æ—É—Ç–±—É–∫</option>
                            <option value="pc" {% if type_filter == 'pc' %}selected{% endif %}>–ö–æ–º–ø—å—é—Ç–µ—Ä</option>
                            <option value="monitor" {% if type_filter == 'monitor' %}selected{% endif %}>–ú–æ–Ω–∏—Ç–æ—Ä</option>
                            <option value="keyboard" {% if type_filter == 'keyboard' %}selected{% endif %}>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
                            </option>
                            <option value="mouse" {% if type_filter == 'mouse' %}selected{% endif %}>–ú—ã—à—å</option>
                            <option value="printer" {% if type_filter == 'printer' %}selected{% endif %}>–ü—Ä–∏–Ω—Ç–µ—Ä</option>
                            <option value="scanner" {% if type_filter == 'scanner' %}selected{% endif %}>–°–∫–∞–Ω–µ—Ä</option>
                            <option value="headphones" {% if type_filter == 'headphones' %}selected{% endif %}>–ù–∞—É—à–Ω–∏–∫–∏
                            </option>
                            <option value="phone" {% if type_filter == 'phone' %}selected{% endif %}>–¢–µ–ª–µ—Ñ–æ–Ω</option>
                            <option value="webcam" {% if type_filter == 'webcam' %}selected{% endif %}>–í–µ–±-–∫–∞–º–µ—Ä–∞</option>
                            <option value="other" {% if type_filter == 'other' %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">–û—Ç–¥–µ–ª —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                        <select name="department" class="form-select form-select-sm" onchange="this.form.submit()">
                            <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}" {% if
                                department_filter|stringformat:"s" == department.id|stringformat:"s" %}selected{% endif
                                %}>
                                {{ department.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">–û—Ç–¥–µ–ª</label>
                        <select name="assigned_department" class="form-select form-select-sm"
                            onchange="this.form.submit()">
                            <option value="">–í—Å–µ –æ—Ç–¥–µ–ª—ã (–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}" {% if
                                assigned_department_filter|stringformat:"s" == department.id|stringformat:"s" %}selected{%
                                endif %}>
                                {{ department.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="col-md-6 text-end">
                <span class="text-muted">
                    –í—Å–µ–≥–æ: {{ equipments.count }} –µ–¥–∏–Ω–∏—Ü
                </span>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
        {% if equipments %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>–ú–¶ –Ω–æ–º–µ—Ä</th>
                        <th>–¢–∏–ø</th>
                        <th>–ú–∞—Ä–∫–∞/–ú–æ–¥–µ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –∑–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in equipments %}
                    <tr>
                        <td>
                            {% if item.mc_number %}
                            <strong>{{ item.mc_number }}</strong>
                            {% else %}
                            <strong class="text-muted">–ë–µ–∑ –ú–¶</strong>
                            {% endif %}
                        </td>
                        <td>{{ item.get_type_display }}</td>
                        <td>
                            {% if item.brand or item.model %}
                            {% if item.brand %}{{ item.brand }}{% endif %}
                            {% if item.model %}{{ item.model }}{% endif %}
                            {% else %}
                            <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.status == 'available' %}
                            <span class="badge bg-success status-badge">–ù–∞ —Å–∫–ª–∞–¥–µ</span>
                            {% elif item.status == 'issued' %}
                            <span class="badge bg-primary status-badge">–í—ã–¥–∞–Ω–æ</span>
                            {% elif item.status == 'broken' %}
                            <span class="badge bg-danger status-badge">–°–ª–æ–º–∞–Ω</span>
                            {% elif item.status == 'repair' %}
                            <span class="badge bg-warning text-dark status-badge">–í —Ä–µ–º–æ–Ω—Ç–µ</span>
                            {% elif item.status == 'written_off' %}
                            <span class="badge bg-secondary status-badge">–°–ø–∏—Å–∞–Ω</span>
                            {% else %}
                            <span class="badge bg-light text-dark status-badge">{{ item.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.assigned_to %}
                            <a href="{% url 'employees:employee_detail' item.assigned_to.pk %}"
                                class="text-decoration-none">
                                üë§ {{ item.assigned_to.full_name }}
                            </a>
                            {% if item.assigned_to.department %}
                            <br><small class="text-muted">{{ item.assigned_to.department.name }}</small>
                            {% endif %}
                            {% elif item.assigned_department %}
                            <span class="text-decoration-none">
                                üè¢ {{ item.assigned_department.name }}
                            </span>
                            {% else %}
                            <span class="text-muted">–ù–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'equipments:equipment_detail' item.pk %}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/admin/equipments/equipment/{{ item.pk }}/change/"
                                class="btn btn-sm btn-outline-secondary" target="_blank">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h5 class="mt-3">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h5>
            <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É</p>
        </div>
        {% endif %}
    </div>
</div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
        <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form method="get" id="filterForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="filterModalLabel">
                                <i class="bi bi-funnel me-2"></i>–§–ò–õ–¨–¢–†–´ –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                        </div>
                        
                        <div class="modal-body">
                            <!-- 1. –°–¢–ê–¢–£–° -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-circle-fill text-danger me-2"></i>–°—Ç–∞—Ç—É—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                    <small class="text-muted">(–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)</small>
                                </h6>
                                <div class="row">
                                    {% for status_value, status_name in status_choices %}
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="status" 
                                                   value="{{ status_value }}" 
                                                   id="status_{{ status_value }}"
                                                   {% if status_value in selected_statuses %}checked{% endif %}>
                                            <label class="form-check-label" for="status_{{ status_value }}">
                                                {% if status_value == 'available' %}
                                                <span class="badge bg-success">{{ status_name }}</span>
                                                {% elif status_value == 'issued' %}
                                                <span class="badge bg-primary">{{ status_name }}</span>
                                                {% elif status_value == 'broken' %}
                                                <span class="badge bg-danger">{{ status_name }}</span>
                                                {% elif status_value == 'repair' %}
                                                <span class="badge bg-warning text-dark">{{ status_name }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ status_name }}</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- 2. –¢–ò–ü -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-box-seam text-primary me-2"></i>–¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                                    <small class="text-muted">(–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)</small>
                                </h6>
                                <div class="row">
                                    {% for type_value, type_name in type_choices %}
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="type" 
                                                   value="{{ type_value }}" 
                                                   id="type_{{ type_value }}"
                                                   {% if type_value in selected_types %}checked{% endif %}>
                                            <label class="form-check-label" for="type_{{ type_value }}">
                                                {% if type_value == 'laptop' %}<i class="bi bi-laptop me-1"></i>
                                                {% elif type_value == 'pc' %}<i class="bi bi-pc me-1"></i>
                                                {% elif type_value == 'monitor' %}<i class="bi bi-display me-1"></i>
                                                {% elif type_value == 'printer' %}<i class="bi bi-printer me-1"></i>
                                                {% elif type_value == 'keyboard' %}<i class="bi bi-keyboard me-1"></i>
                                                {% elif type_value == 'mouse' %}<i class="bi bi-mouse me-1"></i>
                                                {% endif %}
                                                {{ type_name }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <!-- 3. –ß–¢–û –ù–ï –ó–ê–ü–û–õ–ù–ï–ù–û -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>–ß—Ç–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ?
                                    <small class="text-muted">(—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç)</small>
                                </h6>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="missing" 
                                                   id="missing_all" value="" 
                                                   {% if not missing_filter %}checked{% endif %}>
                                            <label class="btn btn-outline-secondary" for="missing_all">
                                                –í—Å–µ –∑–∞–ø–∏—Å–∏
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="missing" 
                                                   id="missing_mc" value="mc" 
                                                   {% if missing_filter == 'mc' %}checked{% endif %}>
                                            <label class="btn btn-outline-warning" for="missing_mc">
                                                –ë–µ–∑ –ú–¶
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="missing" 
                                                   id="missing_brand" value="brand" 
                                                   {% if missing_filter == 'brand' %}checked{% endif %}>
                                            <label class="btn btn-outline-warning" for="missing_brand">
                                                –ë–µ–∑ –º–∞—Ä–∫–∏
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="missing" 
                                                   id="missing_model" value="model" 
                                                   {% if missing_filter == 'model' %}checked{% endif %}>
                                            <label class="btn btn-outline-warning" for="missing_model">
                                                –ë–µ–∑ –º–æ–¥–µ–ª–∏
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 4. –°–û–†–¢–ò–†–û–í–ö–ê -->
                            <div class="mb-4">
                                <h6 class="mb-3">
                                    <i class="bi bi-sort-down text-info me-2"></i>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select" name="sort">
                                            <option value="mc" {% if sort_filter == 'mc_number' %}selected{% endif %}>–ü–æ –ú–¶ –Ω–æ–º–µ—Ä—É</option>
                                            <option value="-mc" {% if sort_filter == '-mc_number' %}selected{% endif %}>–ü–æ –ú–¶ (–æ–±—Ä–∞—Ç–Ω–æ)</option>
                                            <option value="type" {% if sort_filter == 'type' %}selected{% endif %}>–ü–æ —Ç–∏–ø—É (–ê-–Ø)</option>
                                            <option value="-type" {% if sort_filter == '-type' %}selected{% endif %}>–ü–æ —Ç–∏–ø—É (–Ø-–ê)</option>
                                            <option value="model" {% if sort_filter == 'model' %}selected{% endif %}>–ü–æ –º–æ–¥–µ–ª–∏ (–ê-–Ø)</option>
                                            <option value="-model" {% if sort_filter == '-model' %}selected{% endif %}>–ü–æ –º–æ–¥–µ–ª–∏ (–Ø-–ê)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-lg"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>
        // JavaScript –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∞–±–º–∏—Ç–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            // –§–æ—Ä–º–∞ —Å–∞–±–º–∏—Ç–∏—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
        });
        </script>
    </div>
</div>
{% endblock %}
